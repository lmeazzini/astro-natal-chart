name: Deploy to Production

on:
  push:
    branches: [main]
  workflow_dispatch:  # Allow manual deployment trigger

env:
  DEPLOY_TIMEOUT: 15  # minutes

jobs:
  deploy:
    name: Deploy to EC2
    runs-on: ubuntu-latest
    timeout-minutes: 15

    steps:
      - name: Deploy to EC2 via SSH
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ${{ secrets.EC2_USER }}
          key: ${{ secrets.EC2_SSH_KEY }}
          port: 22
          command_timeout: 15m
          script: |
            cd /opt/astro-natal-chart
            bash scripts/deploy.sh

      - name: Wait for services to stabilize
        run: sleep 10

      - name: Verify deployment health
        run: |
          echo "Checking health endpoint..."
          MAX_RETRIES=5
          RETRY_COUNT=0

          while [ $RETRY_COUNT -lt $MAX_RETRIES ]; do
            if curl -f -s -o /dev/null -w "%{http_code}" https://${{ secrets.DOMAIN }}/health | grep -q "200"; then
              echo "‚úÖ Health check passed!"
              exit 0
            fi

            RETRY_COUNT=$((RETRY_COUNT + 1))
            echo "Health check failed (attempt $RETRY_COUNT/$MAX_RETRIES). Retrying in 5 seconds..."
            sleep 5
          done

          echo "‚ùå Health check failed after $MAX_RETRIES attempts"
          exit 1

      - name: Deployment summary
        if: always()
        run: |
          if [ ${{ job.status }} == 'success' ]; then
            echo "üöÄ Deployment completed successfully!"
            echo "üåê Application: https://${{ secrets.DOMAIN }}"
          else
            echo "‚ùå Deployment failed! Check logs above."
            echo "üí° To rollback manually, SSH to EC2 and run: bash scripts/rollback.sh"
          fi
